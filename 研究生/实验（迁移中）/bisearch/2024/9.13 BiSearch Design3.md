# Adaptive Ratio Setting

## Motivation & Design

自动设置Ratio可以增强BiSearch在不同workloads上的健壮性，并且相比于fix ratio更好解释其合理性。

具体做法：

1. 对于进入系统的每个chunk，首先 考虑用locality寻找base chunk并进行delta compression，得到改chunk的delta compression ratio。
    
2. 对本次的delta compression进行一个合理性判断，具体如下：
    
    1. 计算一个当前workloads上lz4的平均压缩率 Rlz4，以此作为后续估计中该chunk的lz4压缩率。
        
    2. 计算估计当前workloads上每个basechunk被多少个delta chunk依赖，直接使用当前系统中deltaChunkNum除以baseChunkNum，将这个结果记为newDeltaNum。
        
    3. 计算估计当前系统的DCR，就是取系统中所有delta chunk的compression ratio的算术平均值。
        
    4. 利用上述结果得到一个Adaptive Ratio = Rlz4 + DCR * newDeltaNum。
        
    5. 将Adaptive Ratio与当前chunk用locality方式做delta compression的压缩率相比，大于Adaptive Ratio就认为当前locality做的delta compression合理，反之不合理。
        

## Problem

当前计算的adaptive raito会随着backup数量增加越来越大，这也是利用统计数据（平均值等）进行预测无法避免的问题，导致后续使用Adaptive ratio来进行判断过于严格。大部分locality做的delta compression都被discard（被discard的chunks会使用odess寻找basechunk进行delta compression或者直接lz4）实验数据上看大部分deltachunk都是用odess做的（around 60%-75%），这实际上偏离了论文最初的motivation并且overall compression ratio也低于fix ratio 8下的bisearch。并且更多实用odess做delta compression也会导致bisearch的吞吐量变差。

  

因此做出了以下改进：

因为当前的Adaptive Ratio比较严格，所以如果被认为合理的chunk肯定要接受（图中绿色的那一部分），理论上这部分chunk即使使用Odess也大概率可以找到，并且使用locality处理可以获得更好的吞吐量（无需计算feature），并不是BiSearch优化Storage saving的重点；被判定为不合理的chunk全部丢给feature-mode去处理也不合理。这部分chunk中的一部分才是BiSearch这个工作的motivation提到的，想要找到的那部分saving提升。因此我们设置一个微调的参数β，考虑接受下图中Adaptive Ratio左边的一部分chunk（图中黄色的部分）。但同时对于效果极差的要舍弃（图中红色部分）。

暂时无法在成电飞书文档外展示此内容

## Data

|   |   |   |   |   |
|---|---|---|---|---|
||Source|WEB|Docker|Log|
|Odess|14.4836|92.1916|17.3841|6.60713|
|BiSearch-8|24.3373|237.917|17.8672|7.60307|
|BiSearch-Adaptive|24.3649|242.35|17.6013|7.58285|

### Source

#### Odess

```JSON
-----------------INSTRUCTION----------------------
./BiSearch -i /mnt/dataset2/LKT -c 1 -m 3 -n 84
-----------------CHUNK NUM-----------------------
logical chunk num: 5677362
unique chunk num: 3015571
base chunk num: 627003
delta chunk num: 2388568
finesse hit:0
-----------------CHUNK SIZE-----------------------
Overall Compression Ratio: 14.4836
logical chunk size: 48257720320
unique chunk size: 3331889391
base chunk size: 2411961402
delta chunk size: 919927989
-----------------Time------------------------------
total time: 1179s
Throughput: 39.0349MiB/s
-----------------Reduct----------------------------
dedup reduct size : 20972217864
delta reduct size : 21126480290
local reduct size : 2827132775
-----------------END-------------------------------
```

#### BiSearch-Adaptive

```JSON
-----------------INSTRUCTION----------------------
./BiSearch -i /mnt/dataset2/LKT -c 4 -m 5 -n 84 -r 10
-----------------CHUNK NUM-----------------------
logical chunk num: 4126581
unique chunk num: 1111289
base chunk num: 370429
delta chunk num: 740860
finesse hit:413820
-----------------CHUNK SIZE-----------------------
Overall Compression Ratio: 24.3649
logical chunk size: 48257720320
unique chunk size: 1980620643
base chunk size: 1379998376
delta chunk size: 600622267
DCE: 26.7706
DCR: 73.781
-----------------Time------------------------------
total time: 1041s
Throughput: 44.2096MiB/s
-----------------Reduct----------------------------
dedup reduct size : 28063208238
delta reduct size : 15478416587
local reduct size : 2735474852
-----------------END-------------------------------
```

### WEB

#### Odess

```JSON
-----------------INSTRUCTION----------------------
./BiSearch -i /mnt/dataset2/WEB -c 1 -m 3 -n 102
-----------------CHUNK NUM-----------------------
logical chunk num: 35905999
unique chunk num: 4116067
base chunk num: 144946
delta chunk num: 3971121
finesse hit:0
-----------------CHUNK SIZE-----------------------
Overall Compression Ratio: 92.1916
logical chunk size: 297546045440
unique chunk size: 3227474103
base chunk size: 581675854
delta chunk size: 2645798249
-----------------Time------------------------------
total time: 2301s
Throughput: 123.321MiB/s
-----------------Reduct----------------------------
dedup reduct size : 258487172501
delta reduct size : 35241542757
local reduct size : 589856079
-----------------END-------------------------------
```

#### BiSearch-Adaptive

```JSON
-----------------INSTRUCTION----------------------
./BiSearch -i /mnt/dataset2/WEB -c 4 -m 5 -n 102 -r 10
-----------------CHUNK NUM-----------------------
logical chunk num: 4635606
unique chunk num: 916260
base chunk num: 183184
delta chunk num: 733076
finesse hit:392156
-----------------CHUNK SIZE-----------------------
Overall Compression Ratio: 242.35
logical chunk size: 297546045440
unique chunk size: 1227755461
base chunk size: 325158143
delta chunk size: 902597318
DCE: 14.6365
DCR: 19.7532
-----------------Time------------------------------
total time: 1719s
Throughput: 165.074MiB/s
-----------------Reduct----------------------------
dedup reduct size : 283118897152
delta reduct size : 12308254522
local reduct size : 891138305
-----------------END-------------------------------
```

### Docker

#### Odess

```JSON
-----------------INSTRUCTION----------------------
./BiSearch -i /mnt/dataset2/cassandra -c 1 -m 3 -n 97
-----------------CHUNK NUM-----------------------
logical chunk num: 4354882
unique chunk num: 838088
base chunk num: 387809
delta chunk num: 450279
finesse hit:0
-----------------CHUNK SIZE-----------------------
Overall Compression Ratio: 17.3841
logical chunk size: 35310059520
unique chunk size: 2031166263
base chunk size: 1915233545
delta chunk size: 115932718
-----------------Time------------------------------
total time: 645s
Throughput: 52.2082MiB/s
-----------------Reduct----------------------------
dedup reduct size : 28487562313
delta reduct size : 3538614810
local reduct size : 1252716134
-----------------END-------------------------------
```

#### BiSearch-Adaptive

```JSON
-----------------INSTRUCTION----------------------
./BiSearch -i /mnt/dataset2/cassandra -c 4 -m 5 -n 97 -r 10
-----------------CHUNK NUM-----------------------
logical chunk num: 4322420
unique chunk num: 836523
base chunk num: 329384
delta chunk num: 507139
finesse hit:85635
-----------------CHUNK SIZE-----------------------
Overall Compression Ratio: 17.6013
logical chunk size: 35310059520
unique chunk size: 2006100869
base chunk size: 1732864452
delta chunk size: 273236417
DCE: 15.5309
DCR: 94.416
-----------------Time------------------------------
total time: 560s
Throughput: 60.1327MiB/s
-----------------Reduct----------------------------
dedup reduct size : 28342444520
delta reduct size : 3970375372
local reduct size : 991138759
-----------------END-------------------------------
```

### Log

#### Odess

```JSON
-----------------INSTRUCTION----------------------
./BiSearch -i /mnt/dataset2/ThunderbirdTar -c 1 -m 3 -n 240
-----------------CHUNK NUM-----------------------
logical chunk num: 3104269
unique chunk num: 3104246
base chunk num: 2986602
delta chunk num: 117644
finesse hit:0
-----------------CHUNK SIZE-----------------------
Overall Compression Ratio: 6.60713
logical chunk size: 31809034240
unique chunk size: 4814352821
base chunk size: 4753923397
delta chunk size: 60429424
-----------------Time------------------------------
total time: 373s
Throughput: 81.3283MiB/s
-----------------Reduct----------------------------
dedup reduct size : 96390
delta reduct size : 921109703
local reduct size : 26073475326
-----------------END-------------------------------
```

#### BiSearch-Adaptive

```JSON
-----------------INSTRUCTION----------------------
./BiSearch -i /mnt/dataset2/ThunderbirdTar -c 4 -m 5 -n 240 -r 10
-----------------CHUNK NUM-----------------------
logical chunk num: 2699747
unique chunk num: 2699591
base chunk num: 1387161
delta chunk num: 1312430
finesse hit:6749
-----------------CHUNK SIZE-----------------------
Overall Compression Ratio: 7.58285
logical chunk size: 31809034240
unique chunk size: 4194867035
base chunk size: 3151455661
delta chunk size: 1043411374
DCE: 14.0528
DCR: 15.3384
-----------------Time------------------------------
total time: 416s
Throughput: 72.9218MiB/s
-----------------Reduct----------------------------
dedup reduct size : 584655
delta reduct size : 13619407489
local reduct size : 13994175061
-----------------END-------------------------------
```